<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultNodeItemFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.metapath.item.node</a> &gt; <span class="el_source">DefaultNodeItemFactory.java</span></div><h1>DefaultNodeItemFactory.java</h1><pre class="source lang-java linenums">
package gov.nist.secauto.metaschema.core.metapath.item.node;

import gov.nist.secauto.metaschema.core.metapath.item.node.IFeatureFlagContainerItem.FlagContainer;
import gov.nist.secauto.metaschema.core.metapath.item.node.IFeatureModelContainerItem.ModelContainer;
import gov.nist.secauto.metaschema.core.model.IAssemblyInstanceGrouped;
import gov.nist.secauto.metaschema.core.model.IChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IFlagInstance;
import gov.nist.secauto.metaschema.core.model.IModelInstance;
import gov.nist.secauto.metaschema.core.model.IModule;
import gov.nist.secauto.metaschema.core.model.INamedModelInstance;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceGrouped;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;

import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.xml.namespace.QName;

import edu.umd.cs.findbugs.annotations.NonNull;

@SuppressWarnings(&quot;PMD.CouplingBetweenObjects&quot;)
final class DefaultNodeItemFactory
    extends AbstractNodeItemFactory {
  @NonNull
<span class="fc" id="L35">  static final DefaultNodeItemFactory SINGLETON = new DefaultNodeItemFactory();</span>

  /**
   * Get the singleton instance of this node factory.
   *
   * @return the node factory instance
   */
  @NonNull
  public static DefaultNodeItemFactory instance() {
<span class="fc" id="L44">    return SINGLETON;</span>
  }

  private DefaultNodeItemFactory() {
    // prevent construction
  }

  @Override
  @NonNull
  public Supplier&lt;FlagContainer&gt; newDataModelSupplier(@NonNull IFieldNodeItem item) {
<span class="fc" id="L54">    return () -&gt; {</span>
<span class="fc" id="L55">      Map&lt;QName, IFlagNodeItem&gt; flags = generateFlags(item);</span>
<span class="fc" id="L56">      return new FlagContainer(flags);</span>
    };
  }

  @Override
  @NonNull
  public Supplier&lt;ModelContainer&gt; newDataModelSupplier(@NonNull IAssemblyNodeItem item) {
<span class="fc" id="L63">    return () -&gt; {</span>
<span class="fc" id="L64">      Map&lt;QName, IFlagNodeItem&gt; flags = generateFlags(item);</span>
<span class="fc" id="L65">      Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; modelItems = generateModelItems(item);</span>
<span class="fc" id="L66">      return new ModelContainer(flags, modelItems);</span>
    };
  }

  @Override
  public Supplier&lt;ModelContainer&gt; newDataModelSupplier(IRootAssemblyNodeItem item) {
<span class="nc" id="L72">    return () -&gt; {</span>
<span class="nc" id="L73">      Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; modelItems = CollectionUtil.singletonMap(</span>
<span class="nc" id="L74">          item.getQName(),</span>
<span class="nc" id="L75">          CollectionUtil.singletonList(item));</span>
<span class="nc" id="L76">      return new ModelContainer(CollectionUtil.emptyMap(), modelItems);</span>
    };
  }

  /**
   * Given the provided parent node item, generate a mapping of flag name to flag
   * node item for each flag on the parent assembly.
   *
   * @param parent
   *          the parent assembly containing flags
   * @return a mapping of flag name to flag item
   */
  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;) // need an ordered Map
  @NonNull
  protected Map&lt;QName, IFlagNodeItem&gt; generateFlags(@NonNull IModelNodeItem&lt;?, ?&gt; parent) {
<span class="fc" id="L91">    Map&lt;QName, IFlagNodeItem&gt; retval = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L93">    Object parentValue = parent.getValue();</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">    assert parentValue != null;</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">    for (IFlagInstance instance : parent.getDefinition().getFlagInstances()) {</span>
<span class="fc" id="L96">      Object flagValue = instance.getValue(parentValue);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">      if (flagValue != null) {</span>
<span class="fc" id="L98">        IFlagNodeItem item = newFlagNodeItem(instance, parent, flagValue);</span>
<span class="fc" id="L99">        retval.put(instance.getXmlQName(), item);</span>
      }
<span class="fc" id="L101">    }</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">    return retval.isEmpty() ? CollectionUtil.emptyMap() : CollectionUtil.unmodifiableMap(retval);</span>
  }

  /**
   * Given the provided parent node item, generate a mapping of model instance
   * name to model node item(s) for each model instance on the parent assembly.
   *
   * @param parent
   *          the parent assembly containing model instances
   * @return a mapping of model instance name to model node item(s)
   */
  @SuppressWarnings({ &quot;PMD.UseConcurrentHashMap&quot;, &quot;PMD.CognitiveComplexity&quot; }) // need an ordered map
  @NonNull
  protected Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; generateModelItems(
      @NonNull IAssemblyNodeItem parent) {
<span class="fc" id="L117">    Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; retval = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L119">    Object parentValue = parent.getValue();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">    assert parentValue != null;</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">    for (IModelInstance instance : CollectionUtil.toIterable(getValuedModelInstances(parent.getDefinition()))) {</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">      if (instance instanceof INamedModelInstanceAbsolute) {</span>
<span class="fc" id="L123">        INamedModelInstanceAbsolute namedInstance = (INamedModelInstanceAbsolute) instance;</span>

<span class="fc" id="L125">        Object instanceValue = namedInstance.getValue(parentValue);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (instanceValue != null) {</span>
<span class="fc" id="L127">          List&lt;IModelNodeItem&lt;?, ?&gt;&gt; items = generateModelInstanceItems(</span>
              parent,
              namedInstance,
<span class="fc" id="L130">              ObjectUtils.notNull(namedInstance.getItemValues(instanceValue).stream()));</span>
<span class="fc" id="L131">          retval.put(namedInstance.getXmlQName(), items);</span>
        }
<span class="pc bnc" id="L133" title="All 2 branches missed.">      } else if (instance instanceof IChoiceGroupInstance) {</span>
<span class="nc" id="L134">        IChoiceGroupInstance choiceInstance = (IChoiceGroupInstance) instance;</span>

<span class="nc" id="L136">        Object instanceValue = choiceInstance.getValue(parentValue);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (instanceValue != null) {</span>
<span class="nc" id="L138">          Map&lt;INamedModelInstanceGrouped, List&lt;Object&gt;&gt; instanceMap</span>
<span class="nc" id="L139">              = choiceInstance.getItemValues(instanceValue).stream()</span>
<span class="nc" id="L140">                  .map(item -&gt; {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                    assert item != null;</span>
<span class="nc" id="L142">                    INamedModelInstanceGrouped itemInstance = choiceInstance.getItemInstance(item);</span>
<span class="nc" id="L143">                    return Map.entry(itemInstance, item);</span>
                  })
<span class="nc" id="L145">                  .collect(Collectors.groupingBy(</span>
<span class="nc" id="L146">                      entry -&gt; entry.getKey(),</span>
                      LinkedHashMap::new,
<span class="nc" id="L148">                      Collectors.mapping(entry -&gt; entry.getValue(), Collectors.toUnmodifiableList())));</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">          for (Map.Entry&lt;INamedModelInstanceGrouped, List&lt;Object&gt;&gt; entry : instanceMap.entrySet()) {</span>
<span class="nc" id="L151">            INamedModelInstanceGrouped namedInstance = entry.getKey();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            assert namedInstance != null;</span>

<span class="nc" id="L154">            List&lt;IModelNodeItem&lt;?, ?&gt;&gt; items = generateModelInstanceItems(</span>
                parent,
                namedInstance,
<span class="nc" id="L157">                ObjectUtils.notNull(entry.getValue().stream()));</span>
<span class="nc" id="L158">            retval.put(namedInstance.getXmlQName(), items);</span>
<span class="nc" id="L159">          }</span>
        }
      }

<span class="fc" id="L163">    }</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">    return retval.isEmpty() ? CollectionUtil.emptyMap() : CollectionUtil.unmodifiableMap(retval);</span>
  }

  private List&lt;IModelNodeItem&lt;?, ?&gt;&gt; generateModelInstanceItems(
      @NonNull IAssemblyNodeItem parent,
      @NonNull INamedModelInstance namedInstance,
      @NonNull Stream&lt;?&gt; itemValues) {
<span class="fc" id="L171">    AtomicInteger index = new AtomicInteger(); // NOPMD - intentional</span>

    // the item values will be all non-null items
<span class="fc" id="L174">    return itemValues.map(itemValue -&gt; {</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">      assert itemValue != null;</span>
<span class="fc" id="L176">      return newModelItem(namedInstance, parent, index.incrementAndGet(), itemValue);</span>
<span class="fc" id="L177">    }).collect(Collectors.toUnmodifiableList());</span>
  }

  @Override
  public Supplier&lt;ModelContainer&gt; newMetaschemaModelSupplier(@NonNull IModuleNodeItem item) {
<span class="fc" id="L182">    return () -&gt; {</span>
<span class="fc" id="L183">      IModule module = item.getModule();</span>

      // build flags from Metaschema definitions
<span class="fc" id="L186">      Map&lt;QName, IFlagNodeItem&gt; flags = ObjectUtils.notNull(</span>
<span class="fc" id="L187">          Collections.unmodifiableMap(module.getExportedFlagDefinitions().stream()</span>
<span class="fc" id="L188">              .map(def -&gt; newFlagNodeItem(ObjectUtils.notNull(def), item))</span>
<span class="fc" id="L189">              .collect(</span>
<span class="fc" id="L190">                  Collectors.toMap(</span>
                      IFlagNodeItem::getQName,
<span class="fc" id="L192">                      Function.identity(),</span>
<span class="nc" id="L193">                      (v1, v2) -&gt; v2,</span>
                      LinkedHashMap::new))));

      // build model items from Metaschema definitions
<span class="fc" id="L197">      Stream&lt;IFieldNodeItem&gt; fieldStream = module.getExportedFieldDefinitions().stream()</span>
<span class="fc" id="L198">          .map(def -&gt; newFieldNodeItem(ObjectUtils.notNull(def), item));</span>
<span class="fc" id="L199">      Stream&lt;IAssemblyNodeItem&gt; assemblyStream = module.getExportedAssemblyDefinitions().stream()</span>
<span class="fc" id="L200">          .map(def -&gt; newAssemblyNodeItem(ObjectUtils.notNull(def), item));</span>

<span class="fc" id="L202">      Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; modelItems</span>
<span class="fc" id="L203">          = ObjectUtils.notNull(Stream.concat(fieldStream, assemblyStream)</span>
<span class="fc" id="L204">              .collect(</span>
<span class="fc" id="L205">                  Collectors.collectingAndThen(</span>
<span class="fc" id="L206">                      Collectors.groupingBy(IModelNodeItem::getQName),</span>
                      Collections::unmodifiableMap)));
<span class="fc" id="L208">      return new ModelContainer(flags, modelItems);</span>
    };
  }

  @Override
  public Supplier&lt;FlagContainer&gt; newMetaschemaModelSupplier(@NonNull IFieldNodeItem item) {
<span class="fc" id="L214">    return () -&gt; {</span>
<span class="fc" id="L215">      Map&lt;QName, IFlagNodeItem&gt; flags = generateMetaschemaFlags(item);</span>
<span class="fc" id="L216">      return new FlagContainer(flags);</span>
    };
  }

  @Override
  public Supplier&lt;ModelContainer&gt; newMetaschemaModelSupplier(
      @NonNull IAssemblyNodeItem item) {
<span class="fc" id="L223">    return () -&gt; {</span>
<span class="fc" id="L224">      Map&lt;QName, IFlagNodeItem&gt; flags = generateMetaschemaFlags(item);</span>
<span class="fc" id="L225">      Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; modelItems = generateMetaschemaModelItems(item);</span>
<span class="fc" id="L226">      return new ModelContainer(flags, modelItems);</span>
    };
  }

  @NonNull
  protected Map&lt;QName, IFlagNodeItem&gt; generateMetaschemaFlags(
      @NonNull IModelNodeItem&lt;?, ?&gt; parent) {
<span class="fc" id="L233">    Map&lt;QName, IFlagNodeItem&gt; retval = new LinkedHashMap&lt;&gt;(); // NOPMD - intentional</span>

<span class="fc bfc" id="L235" title="All 2 branches covered.">    for (IFlagInstance instance : parent.getDefinition().getFlagInstances()) {</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">      assert instance != null;</span>
<span class="fc" id="L237">      IFlagNodeItem item = newFlagNodeItem(instance, parent);</span>
<span class="fc" id="L238">      retval.put(instance.getXmlQName(), item);</span>
<span class="fc" id="L239">    }</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">    return retval.isEmpty() ? CollectionUtil.emptyMap() : CollectionUtil.unmodifiableMap(retval);</span>
  }

  @NonNull
  protected Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; generateMetaschemaModelItems(
      @NonNull IAssemblyNodeItem parent) {
<span class="fc" id="L246">    Map&lt;QName, List&lt;? extends IModelNodeItem&lt;?, ?&gt;&gt;&gt; retval = new LinkedHashMap&lt;&gt;(); // NOPMD - intentional</span>

<span class="fc bfc" id="L248" title="All 2 branches covered.">    for (INamedModelInstance instance : CollectionUtil.toIterable(getNamedModelInstances(parent.getDefinition()))) {</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">      assert instance != null;</span>
<span class="fc" id="L250">      IModelNodeItem&lt;?, ?&gt; item = newModelItem(instance, parent);</span>
<span class="fc" id="L251">      retval.put(instance.getXmlQName(), Collections.singletonList(item));</span>
<span class="fc" id="L252">    }</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">    return retval.isEmpty() ? CollectionUtil.emptyMap() : CollectionUtil.unmodifiableMap(retval);</span>
  }

  @Override
  public IAssemblyNodeItem newAssemblyNodeItem(IAssemblyInstanceGrouped instance, IAssemblyNodeItem parent,
      int position, Object value) {
<span class="nc" id="L259">    throw new UnsupportedOperationException(&quot;implement&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>